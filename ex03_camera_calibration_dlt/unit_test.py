# ============================================================
# File        : unit_test.py
# Author      : Elham Khazaee
# Course      : Photogrammetric Computer Vision
# Program     : M.Sc. Geodesy and Geoinformation Science, TU Berlin
# Description : Exercise 03 â€“ Camera Calibration (DLT).
#               Unit tests to validate DLT calibration and projections.
# ============================================================

from __future__ import annotations

import unittest

import numpy as np

from Helper import ProjectionMatrixInterpretation
from Pcv3 import (
    GeometryType,
    apply_h_2d,
    apply_h_3d_points,
    calibrate,
    decondition_camera,
    get_condition_2d,
    get_condition_3d,
    get_design_matrix_camera,
    interprete,
    solve_dlt_camera,
)


class TestConditioning(unittest.TestCase):
    def test_condition_2d(self) -> None:
        pts = [
            np.array([93.0, 617.0, 1.0]),
            np.array([729.0, 742.0, 1.0]),
            np.array([703.0, 1233.0, 1.0]),
            np.array([152.0, 1103.0, 1.0]),
        ]
        expected = np.array(
            [
                [1.0 / 296.75, 0, -419.25 / 296.75],
                [0, 1.0 / 244.25, -923.75 / 244.25],
                [0, 0, 1],
            ],
            dtype=np.float64,
        )
        T = get_condition_2d(pts)
        T /= T[2, 2]
        np.testing.assert_allclose(T, expected, atol=1e-3)

    def test_condition_3d(self) -> None:
        pts = [
            np.array([44.7, -142.4, 258.7, 1.0]),
            np.array([-103.6, -146.6, 154.4, 1.0]),
            np.array([47.4, -150.1, 59.8, 1.0]),
            np.array([-152.2, 59.4, 245.2, 1.0]),
            np.array([-153.3, -96.9, 151.3, 1.0]),
            np.array([-149.4, 52.7, 46.9, 1.0]),
        ]
        expected = np.array(
            [
                [0.012117948, 0, 0, 0.9419685],
                [0, 0.011838989, 0, 0.83642465],
                [0, 0, 0.014988759, -2.2890332],
                [0, 0, 0, 1],
            ],
            dtype=np.float64,
        )
        T = get_condition_3d(pts)
        T /= T[3, 3]
        np.testing.assert_allclose(T, expected, atol=1e-3)


class TestDesignMatrix(unittest.TestCase):
    def setUp(self) -> None:
        self.points2d = [
            np.array([-1.3006536, -1.5473859, 1]),
            np.array([-0.34284019, 0.11029005, 1]),
            np.array([-1.3565062, 1.3622761, 1]),
            np.array([1.3565062, -1.4526141, 1]),
            np.array([0.27510405, 0.1202662, 1]),
            np.array([1.3683897, 1.4071679, 1]),
        ]
        self.points3d = [
            np.array([1.4836408, -0.84944731, 1.5885589, 1]),
            np.array([-0.31345099, -0.89917129, 0.025231123, 1]),
            np.array([1.5163593, -0.94060773, -1.3927054, 1]),
            np.array([-0.90238315, 1.5396607, 1.3862104, 1]),
            np.array([-0.91571301, -0.31077343, -0.021234035, 1]),
            np.array([-0.86845297, 1.4603393, -1.5860603, 1]),
        ]

    def test_design_matrix(self) -> None:
        A = get_design_matrix_camera(self.points2d, self.points3d)
        expected = np.array(
            [
                [-1.4836408, 0.84944731, -1.5885589, -1, 0, 0, 0, 0, -1.9297028, 1.1048367, -2.0661647, -1.3006536],
                [0, 0, 0, 0, -1.4836408, 0.84944731, -1.5885589, -1, -2.2957649, 1.3144228, -2.4581137, -1.5473859],
                [0.31345099, 0.89917129, -0.025231123, -1, 0, 0, 0, 0, 0.1074636, 0.30827206, -0.0086502433, -0.34284019],
                [0, 0, 0, 0, 0.31345099, 0.89917129, -0.025231123, -1, -0.034570526, -0.099169649, 0.0027827418, 0.11029005],
                [-1.5163593, 0.94060773, 1.3927054, -1, 0, 0, 0, 0, -2.0569508, 1.2759403, 1.8892136, -1.3565062],
                [0, 0, 0, 0, -1.5163593, 0.94060773, 1.3927054, -1, 2.0657001, -1.2813674, -1.8972493, 1.3622761],
                [0.90238315, -1.5396607, -1.3862104, -1, 0, 0, 0, 0, -1.2240883, 2.0885594, 1.880403, 1.3565062],
                [0, 0, 0, 0, 0.90238315, -1.5396607, -1.3862104, -1, 1.3108145, -2.2365327, -2.0136287, -1.4526141],
                [0.91571301, 0.31077343, 0.021234035, -1, 0, 0, 0, 0, -0.25191635, -0.085495025, -0.005841569, 0.27510405],
                [0, 0, 0, 0, 0.91571301, 0.31077343, 0.021234035, -1, -0.11012933, -0.03737554, -0.0025537368, 0.1202662],
                [0.86845297, -1.4603393, 1.5860603, -1, 0, 0, 0, 0, -1.1883821, 1.9983133, -2.1703486, 1.3683897],
                [0, 0, 0, 0, 0.86845297, -1.4603393, 1.5860603, -1, -1.2220591, 2.0549426, -2.2318532, 1.4071679],
            ],
            dtype=np.float64,
        )
        np.testing.assert_allclose(A, expected, atol=1e-3)


class TestDLT(unittest.TestCase):
    def setUp(self) -> None:
        self.A = np.array(
            [
                [-1.4836408, 0.84944731, -1.5885589, -1, 0, 0, 0, 0, -1.9297028, 1.1048367, -2.0661647, -1.3006536],
                [0, 0, 0, 0, -1.4836408, 0.84944731, -1.5885589, -1, -2.2957649, 1.3144228, -2.4581137, -1.5473859],
                [0.31345099, 0.89917129, -0.025231123, -1, 0, 0, 0, 0, 0.1074636, 0.30827206, -0.0086502433, -0.34284019],
                [0, 0, 0, 0, 0.31345099, 0.89917129, -0.025231123, -1, -0.034570526, -0.099169649, 0.0027827418, 0.11029005],
                [-1.5163593, 0.94060773, 1.3927054, -1, 0, 0, 0, 0, -2.0569508, 1.2759403, 1.8892136, -1.3565062],
                [0, 0, 0, 0, -1.5163593, 0.94060773, 1.3927054, -1, 2.0657001, -1.2813674, -1.8972493, 1.3622761],
                [0.90238315, -1.5396607, -1.3862104, -1, 0, 0, 0, 0, -1.2240883, 2.0885594, 1.880403, 1.3565062],
                [0, 0, 0, 0, 0.90238315, -1.5396607, -1.3862104, -1, 1.3108145, -2.2365327, -2.0136287, -1.4526141],
                [0.91571301, 0.31077343, 0.021234035, -1, 0, 0, 0, 0, -0.25191635, -0.085495025, -0.005841569, 0.27510405],
                [0, 0, 0, 0, 0.91571301, 0.31077343, 0.021234035, -1, -0.11012933, -0.03737554, -0.0025537368, 0.1202662],
                [0.86845297, -1.4603393, 1.5860603, -1, 0, 0, 0, 0, -1.1883821, 1.9983133, -2.1703486, 1.3683897],
                [0, 0, 0, 0, 0.86845297, -1.4603393, 1.5860603, -1, -1.2220591, 2.0549426, -2.2318532, 1.4071679],
            ],
            dtype=np.float64,
        )

    def test_solve_dlt(self) -> None:
        P = solve_dlt_camera(self.A)
        P /= P[2, 3]
        expected = np.array(
            [
                [-0.32120419, 0.3686696, -0.0095243761, 0.0035335352],
                [-0.052101973, -0.083373591, -0.59302819, -0.0046088211],
                [-0.030212782, -0.026015088, 0.0050823218, 0.63073134],
            ],
            dtype=np.float64,
        )
        expected /= expected[2, 3]
        np.testing.assert_allclose(P, expected, atol=1e-3)

    def test_decondition(self) -> None:
        P = np.array(
            [
                [-0.32120419, 0.3686696, -0.0095243761, 0.0035335352],
                [-0.052101973, -0.083373591, -0.59302819, -0.0046088211],
                [-0.030212782, -0.026015088, 0.0050823218, 0.63073134],
            ],
            dtype=np.float64,
        )
        T2 = np.array(
            [
                [0.011883541, 0, -1.5204991],
                [0, 0.016626639, -2.3255126],
                [0, 0, 1],
            ]
        )
        T3 = np.array(
            [
                [0.012117948, 0, 0, 0.9419685],
                [0, 0.011838989, 0, 0.83642465],
                [0, 0, 0.014988759, -2.2890332],
                [0, 0, 0, 1],
            ]
        )
        P = decondition_camera(T2, T3, P)
        P /= P[2, 3]
        expected = np.array(
            [
                [-0.65811008, 0.57636172, -0.0039836233, 132.55562],
                [-0.15676615, -0.18008056, -0.9210307, 270.33484],
                [-0.00064357655, -0.00054140261, 0.00013390853, 1.0],
            ]
        )
        np.testing.assert_allclose(P, expected, atol=1e-3)


class TestPipeline(unittest.TestCase):
    def setUp(self) -> None:
        self.points2d = [
            np.array([18.5, 46.8, 1.0]),
            np.array([99.1, 146.5, 1.0]),
            np.array([13.8, 221.8, 1.0]),
            np.array([242.1, 52.5, 1.0]),
            np.array([151.1, 147.1, 1.0]),
            np.array([243.1, 224.5, 1.0]),
        ]
        self.points3d = [
            np.array([44.7, -142.4, 258.7, 1.0]),
            np.array([-103.6, -146.6, 154.4, 1.0]),
            np.array([47.4, -150.1, 59.8, 1.0]),
            np.array([-152.2, 59.4, 245.2, 1.0]),
            np.array([-153.3, -96.9, 151.3, 1.0]),
            np.array([-149.4, 52.7, 46.9, 1.0]),
        ]

    def test_calibrate(self) -> None:
        P = calibrate(self.points2d, self.points3d)
        P /= P[2, 3]
        expected = np.array(
            [
                [-0.65811008, 0.57636172, -0.0039836233, 132.55562],
                [-0.15676615, -0.18008056, -0.9210307, 270.33484],
                [-0.00064357655, -0.00054140261, 0.00013390853, 1.0],
            ]
        )
        np.testing.assert_allclose(P, expected, atol=1e-3)

    def test_interprete(self) -> None:
        P = np.array(
            [
                [-0.65811008, 0.57636172, -0.0039836233, 132.55562],
                [-0.15676615, -0.18008056, -0.9210307, 270.33484],
                [-0.00064357655, -0.00054140261, 0.00013390853, 1.0],
            ]
        )
        K, R, info = interprete(P, ProjectionMatrixInterpretation())
        K /= K[2, 2]
        expected_K = np.array(
            [
                [1015.7469, -10.457143, 153.00758],
                [0, 1112.4618, 103.48759],
                [0, 0, 1],
            ]
        )
        np.testing.assert_allclose(K, expected_K, atol=1e-3)
        expected_R = np.array(
            [
                [-0.64794523, 0.76071578, -0.038450673],
                [-0.095171571, -0.13094184, -0.98681134],
                [-0.75571775, -0.63574028, 0.15724166],
            ]
        )
        np.testing.assert_allclose(R, expected_R, atol=1e-3)
        self.assertAlmostEqual(info.principalDistance, 1015.7469, places=3)
        self.assertAlmostEqual(info.skew, 89.410156, places=3)
        self.assertAlmostEqual(info.aspectRatio, 1.0952156, places=3)
        np.testing.assert_allclose(info.principalPoint, [153.00758, 103.48759], atol=1e-3)
        self.assertAlmostEqual(info.omega, 76.107491, places=3)
        self.assertAlmostEqual(info.phi, -49.088123, places=3)
        self.assertAlmostEqual(info.kappa, 171.64403, places=3)
        np.testing.assert_allclose(info.cameraLocation, [890.0155, 786.18341, -11.688845], atol=1e-3)


if __name__ == "__main__":
    unittest.main()
